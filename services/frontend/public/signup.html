<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sign Up - Material Mover</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <main class="container auth">
      <h2>Sign Up</h2>
      <form id="signupForm">
        <label>Email<input type="email" id="email" required placeholder="Enter your email"></label>
        <label>Password<input type="password" id="password" required placeholder="Enter your password"></label>
        <label>I want to:
          <select id="role" required>
            <option value="">Select your role</option>
            <option value="buyer">Buy Materials</option>
            <option value="seller">Sell Materials</option>
          </select>
        </label>
        <button type="submit">Sign Up</button>
      </form>
      <div class="auth-divider">
        <hr><span>OR</span><hr>
      </div>
      <div class="google-signup">
        <label>I want to:
          <select id="googleRole">
            <option value="buyer">Buy Materials</option>
            <option value="seller">Sell Materials</option>
          </select>
        </label>
        <div id="g_id_onload"
             data-client_id="315899476122-jebvtaiu62io7bhej450n8tqcofjmrbi.apps.googleusercontent.com"
             data-callback="handleGoogleSignUp">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-text="signup_with" data-shape="rectangular" data-logo_alignment="left"></div>
      </div>
      <div class="auth-help">
        <p><strong>Choose your role:</strong></p>
        <ul>
          <li><strong>Buyer:</strong> Search and view available materials</li>
          <li><strong>Seller:</strong> List and manage your materials</li>
        </ul>
        <p class="auth-note">Note: Admin access is granted by existing administrators only.</p>
        <p>Have an account? <a href="/login.html">Login</a></p>
      </div>
    </main>
    <script>
      document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;
        
        if (!role) {
          alert('Please select your role (Buyer or Seller)');
          return;
        }

        const resp = await fetch('/api/auth/signup', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ email, password, role }) 
        });
        const j = await resp.json();
        if (resp.ok) {
          alert(`Account created as ${j.role}, please login`);
          location.href = '/login.html';
        } else alert(j.message || JSON.stringify(j));
      });
      
      // Google Sign-Up handler
      async function handleGoogleSignUp(response) {
        try {
          const role = document.getElementById('googleRole').value;
          const resp = await fetch('/api/auth/google', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential: response.credential, role })
          });
          const j = await resp.json();
          if (resp.ok) {
            localStorage.setItem('token', j.token);
            localStorage.setItem('role', j.role);
            localStorage.setItem('email', j.email);
            if (j.role === 'seller') location.href = '/seller.html';
            else if (j.role === 'admin') location.href = '/admin.html';
            else location.href = '/';
          } else {
            alert(j.message || 'Google sign-up failed');
          }
        } catch (error) {
          alert('Google sign-up error: ' + error.message);
        }
      }
    </script>
  </body>
</html>
