<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin - Material Mover</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/toast.css" />

    <style>
      .admin-grid {
        display: grid;
        gap: 20px;
        margin: 20px 0;
      }
      .admin-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.5);
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.admin-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
}
      .user-list {
        margin: 20px 0;
      }
      .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }
      .role-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        background: #e5e7eb;
      }
      .role-badge.admin {
        background: #fde68a;
      }
      .role-badge.seller {
        background: #bfdbfe;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <h1>Admin Dashboard</h1>
      <nav>
        <a href="/">Home</a>
        <a id="logout" href="#">Logout</a>
      </nav>
    </header>
    <main class="container">
      <div class="admin-grid">
        <section class="admin-card">
          <h3>Create New User</h3>
          <form id="createUserForm" class="auth-form">
            <input type="email" id="newEmail" placeholder="Email" required />
            <input
              type="password"
              id="newPassword"
              placeholder="Password"
              required
            />
            <select id="newRole">
              <option value="buyer">Buyer</option>
              <option value="seller">Seller</option>
              <option value="admin">Admin</option>
            </select>
            <button type="submit">Create User</button>
          </form>
        </section>

        <section class="admin-card">
          <h3>Users</h3>
          <div id="userList" class="user-list">Loading...</div>
        </section>

        <section class="admin-card">
          <h3>System Health</h3>
          <button id="health">Check API</button>
          <pre id="out"></pre>
        </section>

        <section class="admin-card">
          <h3>Search & Edit Product</h3>
          <div style="display: flex; gap: 8px; margin-bottom: 8px">
            <input
              id="productQuery"
              placeholder="Search by title or id"
              style="flex: 1"
            />
            <button id="productSearchBtn">Search</button>
          </div>
          <div id="productResults">Enter a query and press Search</div>

          <form id="editProductForm" style="display: none; margin-top: 12px">
            <input type="text" id="editId" readonly style="display: none" />
            <label>Title</label>
            <input type="text" id="editTitle" required />
            <label>Description</label>
            <textarea id="editDescription" rows="3" required></textarea>
            <label>Price (‚Çπ)</label>
            <input type="number" id="editPrice" min="0" step="0.01" required />
            <label>Quantity</label>
            <input type="number" id="editQuantity" min="0" required />
            <label>Category</label>
            <input type="text" id="editCategory" required />
            <label>Address *</label>
            <input type="text" id="editAddress" required />
            <label>Phone Number *</label>
            <input type="tel" id="editPhone" required />
            <label>Image URL</label>
            <input type="text" id="editImage" />
            <div style="margin-top: 8px; display: flex; gap: 8px">
              <button id="saveProductBtn" type="button">Save</button>
              <button id="cancelEditBtn" type="button">Cancel</button>
            </div>
          </form>
        </section>
      </div>
    </main>

    <script src="/js/toast.js"></script>
    <script>
      // --- Auth Check ---
      if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'admin') {
        alert('Please login as admin');
        location.href = '/login.html';
      }

      const token = localStorage.getItem('token');
      const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
      const toast = new Toast();

      // --- Token Expiry Check ---
      function checkTokenExpiry() {
        const token = localStorage.getItem('token');
        if (!token) {
          toast.error('Please login');
          setTimeout(() => location.href = '/login.html', 1500);
          return false;
        }

        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          const expiryTime = payload.exp * 1000;

          if (Date.now() >= expiryTime) {
            localStorage.clear();
            toast.error('Session expired. Please login again.');
            setTimeout(() => location.href = '/login.html', 1500);
            return false;
          }

          return true;
        } catch (e) {
          localStorage.clear();
          toast.error('Invalid session. Please login again.');
          setTimeout(() => location.href = '/login.html', 1500);
          return false;
        }
      }

      // Check token on page load
      checkTokenExpiry();

      // --- Load Users ---
      async function loadUsers() {
        try {
          const r = await fetch('/api/auth/users', { headers });
          if (!r.ok) throw new Error('Failed to load users');
          const users = await r.json();
          const html = users.map(u => `
            <div class="user-item">
              <div>
                ${u.email}
                <span class="role-badge ${u.role}">${u.role}</span>
              </div>
              <div>
                ${u.role !== 'admin' ? `
                  <button onclick="updateRole('${u._id}', 'admin')" class="small">Make Admin</button>
                ` : ''}
                ${u.email !== (localStorage.getItem('email') || '') ? `
                  <button onclick="deleteUser('${u._id}')" class="small" style="margin-left:8px;background:#fca5a5">Delete</button>
                ` : ''}
              </div>
            </div>
          `).join('');
          document.getElementById('userList').innerHTML = html || 'No users found';
        } catch (err) {
          toast.error('‚ùå ' + err.message);
          document.getElementById('userList').innerHTML = 'Error loading users.';
        }
      }

      // --- Create User ---
      document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!checkTokenExpiry()) return;
        
        const email = document.getElementById('newEmail').value.trim();
        const password = document.getElementById('newPassword').value.trim();
        const role = document.getElementById('newRole').value;
        try {
          const r = await fetch('/api/auth/create-user', {
            method: 'POST',
            headers,
            body: JSON.stringify({ email, password, role })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Failed to create user');
          toast.success('‚úÖ User created successfully');
          loadUsers();
          e.target.reset();
        } catch (err) {
          toast.error('‚ùå ' + err.message);
        }
      });

      // --- Update Role ---
      window.updateRole = async function(userId, newRole) {
        try {
          const r = await fetch('/api/auth/update-role', {
            method: 'POST',
            headers,
            body: JSON.stringify({ userId, role: newRole })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Failed to update role');
          toast.success('‚úÖ Role updated successfully');
          loadUsers();
        } catch (err) {
          toast.error('‚ùå ' + err.message);
        }
      }

      // --- Logout ---
      document.getElementById('logout').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.clear();
        toast.info('üîí Logged out');
        setTimeout(() => location.href = '/', 1000);
      });

      // --- Health Check ---
      document.getElementById('health').addEventListener('click', async () => {
        try {
          const r = await fetch('/api/health');
          const j = await r.json();
          toast.info('ü©∫ API Health: ' + (r.ok ? 'OK' : 'Down'));
          document.getElementById('out').innerText = JSON.stringify(j, null, 2);
        } catch (err) {
          toast.error('‚ùå Health check failed: ' + err.message);
        }
      });

      // --- Product Search ---
      document.getElementById('productSearchBtn')?.addEventListener('click', async () => {
        const q = document.getElementById('productQuery').value.trim();
        if (!q) {
          toast.info('üîç Please enter a search query');
          return;
        }
        try {
          const r = await fetch('/api/products/search', {
            method: 'POST',
            headers,
            body: JSON.stringify({ query: q })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Search failed');
          renderProductResults(j.products || []);
          toast.success('‚úÖ Products loaded');
        } catch (err) {
          toast.error('‚ùå ' + err.message);
        }
      });

      // --- Render Product Results ---
      function renderProductResults(products) {
        const container = document.getElementById('productResults');
        if (!products || !products.length) {
          container.innerHTML = '<p>No products found</p>';
          return;
        }
        container.innerHTML = products.map(p => `
          <div style="padding:8px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:12px;align-items:center;">
              <img src="${p.image || '/images/placeholder.png'}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;" />
              <div>
                <div style="font-weight:600">${p.title}</div>
                <div style="font-size:12px;color:#666">ID: ${p._id}</div>
                <div style="font-size:12px;color:#666">Address: ${p.address || ''}</div>
                <div style="font-size:12px;color:#666">Phone: ${p.phone_number || ''}</div>
              </div>
            </div>
            <div>
              <button onclick="loadProductForEdit('${p._id}')" class="small">Edit</button>
              <button onclick="deleteProduct('${p._id}')" class="small" style="margin-left:8px;background:#fca5a5">Delete</button>
            </div>
          </div>
        `).join('');
      }

      // --- Delete Product ---
      window.deleteProduct = async function (id) {
        const confirmToast = document.createElement('div');
        confirmToast.className = 'toast confirm-toast';
        confirmToast.innerHTML = `
          <div class="toast-message">üóëÔ∏è Delete this product permanently?</div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="confirmYes" class="toast-btn yes">Yes, Delete</button>
            <button id="confirmNo" class="toast-btn no">Cancel</button>
          </div>
        `;
        toast.container.appendChild(confirmToast);

        confirmToast.querySelector('#confirmYes').addEventListener('click', async () => {
          confirmToast.remove();
          try {
            const r = await fetch('/api/products/' + id, { method: 'DELETE', headers });
            const j = await r.json();
            if (!r.ok) throw new Error(j.message || 'Delete failed');
            toast.success('‚úÖ Product deleted');
            const q = document.getElementById('productQuery').value.trim();
            if (q) document.getElementById('productSearchBtn').click();
          } catch (err) {
            toast.error('‚ùå Error deleting product: ' + err.message);
          }
        });

        confirmToast.querySelector('#confirmNo').addEventListener('click', () => {
          confirmToast.remove();
          toast.info('Deletion cancelled');
        });
      };

      // --- Delete User ---
      window.deleteUser = async function (id) {
        const confirmToast = document.createElement('div');
        confirmToast.className = 'toast confirm-toast';
        confirmToast.innerHTML = `
          <div class="toast-message">‚ö†Ô∏è Delete this user and all their products?</div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="confirmYes" class="toast-btn yes">Yes, Delete</button>
            <button id="confirmNo" class="toast-btn no">Cancel</button>
          </div>
        `;
        toast.container.appendChild(confirmToast);

        confirmToast.querySelector('#confirmYes').addEventListener('click', async () => {
          confirmToast.remove();
          try {
            const r = await fetch('/api/auth/users/' + id, { method: 'DELETE', headers });
            const j = await r.json();
            if (!r.ok) throw new Error(j.message || 'Delete failed');
            toast.success('‚úÖ User deleted successfully');
            loadUsers();
          } catch (err) {
            toast.error('‚ùå Error deleting user: ' + err.message);
          }
        });

        confirmToast.querySelector('#confirmNo').addEventListener('click', () => {
          confirmToast.remove();
          toast.info('Deletion cancelled');
        });
      };

      // --- Load Product For Edit ---
      window.loadProductForEdit = async function (id) {
        try {
          const r = await fetch('/api/products/' + id, { headers });
          const p = await r.json();
          if (!r.ok) throw new Error(p.message || 'Failed to load product');
          document.getElementById('editId').value = p._id;
          document.getElementById('editTitle').value = p.title || '';
          document.getElementById('editDescription').value = p.description || '';
          document.getElementById('editPrice').value = p.price ?? 0;
          document.getElementById('editQuantity').value = p.quantity ?? 0;
          document.getElementById('editCategory').value = p.category || '';
          document.getElementById('editImage').value = p.image || '';
          document.getElementById('editAddress').value = p.address || '';
          document.getElementById('editPhone').value = p.phone_number || '';
          document.getElementById('editProductForm').style.display = 'block';
          toast.info('‚úèÔ∏è Editing product details');
          document.getElementById('editProductForm').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
          toast.error('‚ùå ' + err.message);
        }
      };

      // --- Cancel Edit ---
      document.getElementById('cancelEditBtn')?.addEventListener('click', () => {
        document.getElementById('editProductForm').style.display = 'none';
        toast.info('‚ùé Edit cancelled');
      });

      // --- Save Product Changes ---
      document.getElementById('saveProductBtn')?.addEventListener('click', async () => {
        const id = document.getElementById('editId').value;
        if (!id) {
          toast.info('‚ö†Ô∏è No product selected');
          return;
        }
        const payload = {
          title: document.getElementById('editTitle').value,
          description: document.getElementById('editDescription').value,
          price: parseFloat(document.getElementById('editPrice').value) || 0,
          quantity: parseInt(document.getElementById('editQuantity').value) || 0,
          category: document.getElementById('editCategory').value,
          address: document.getElementById('editAddress').value,
          phone_number: document.getElementById('editPhone').value,
          image: document.getElementById('editImage').value
        };
        try {
          const r = await fetch('/api/products/' + id, {
            method: 'PUT',
            headers,
            body: JSON.stringify(payload)
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Save failed');
          toast.success('üíæ Product updated successfully');
          document.getElementById('editProductForm').style.display = 'none';
        } catch (err) {
          toast.error('‚ùå ' + err.message);
        }
      });

      // --- Initial Load ---
      loadUsers();
    </script>
  </body>
</html>